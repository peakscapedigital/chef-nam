---
// Lead Management Admin Page
// Fetch leads from BigQuery and display in a table with status management

export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Lead Management | Chef Nam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-new { background-color: #dbeafe; color: #1e40af; }
    .status-contacted { background-color: #fef3c7; color: #92400e; }
    .status-qualified { background-color: #d1fae5; color: #065f46; }
    .status-won { background-color: #bbf7d0; color: #166534; }
    .status-lost { background-color: #fecaca; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Lead Management</h1>
        <p class="text-gray-600 mt-1">Manage and track your catering leads</p>
      </div>
      <div class="flex gap-4">
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          <option value="all">All Leads</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <button id="refreshBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
          Refresh
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-white p-4 rounded-lg shadow-sm border">
        <div class="text-2xl font-bold text-gray-900" id="stat-total">-</div>
        <div class="text-sm text-gray-600">Total Leads</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border">
        <div class="text-2xl font-bold text-blue-600" id="stat-new">-</div>
        <div class="text-sm text-gray-600">New</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border">
        <div class="text-2xl font-bold text-amber-600" id="stat-contacted">-</div>
        <div class="text-sm text-gray-600">Contacted</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border">
        <div class="text-2xl font-bold text-green-600" id="stat-won">-</div>
        <div class="text-sm text-gray-600">Won</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border">
        <div class="text-2xl font-bold text-green-700" id="stat-revenue">-</div>
        <div class="text-sm text-gray-600">Revenue</div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-amber-500 border-t-transparent"></div>
      <p class="mt-4 text-gray-600">Loading leads...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
      <span id="errorMessage"></span>
    </div>

    <!-- Leads Table -->
    <div id="tableContainer" class="hidden bg-white rounded-lg shadow-sm border overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex justify-between items-center mt-4">
      <div class="text-sm text-gray-600">
        Showing <span id="showingStart">0</span>-<span id="showingEnd">0</span> of <span id="showingTotal">0</span>
      </div>
      <div class="flex gap-2">
        <button id="prevBtn" class="px-4 py-2 border rounded-lg disabled:opacity-50" disabled>Previous</button>
        <button id="nextBtn" class="px-4 py-2 border rounded-lg disabled:opacity-50" disabled>Next</button>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div id="notesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
      <h3 class="text-lg font-semibold mb-4">Notes for <span id="notesLeadName"></span></h3>
      <textarea id="notesTextarea" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
      <div class="flex justify-end gap-3 mt-4">
        <button id="cancelNotesBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
        <button id="saveNotesBtn" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">Save Notes</button>
      </div>
    </div>
  </div>

  <!-- Won Modal (for booking value) -->
  <div id="wonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold mb-4">Mark Lead as Won</h3>
      <p class="text-gray-600 mb-4">Enter the booking value for this lead:</p>
      <div class="flex items-center gap-2 mb-4">
        <span class="text-gray-500">$</span>
        <input type="number" id="bookingValueInput" min="0" step="100" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="e.g., 4200">
      </div>
      <div class="flex justify-end gap-3">
        <button id="cancelWonBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
        <button id="confirmWonBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Confirm Won</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let leads = [];
    let currentPage = 0;
    let totalCount = 0;
    const pageSize = 50;
    let currentFilter = 'all';
    let currentNotesLeadId = null;
    let currentWonLeadId = null;

    // Elements
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const tableContainer = document.getElementById('tableContainer');
    const leadsTableBody = document.getElementById('leadsTableBody');
    const pagination = document.getElementById('pagination');
    const statusFilter = document.getElementById('statusFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const notesModal = document.getElementById('notesModal');
    const wonModal = document.getElementById('wonModal');

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Get source display
    function getSource(lead) {
      if (lead.gclid) return 'Google Ads';
      if (lead.fbclid) return 'Facebook';
      if (lead.utm_source) return lead.utm_source;
      if (lead.utm_medium === 'organic') return 'Organic';
      return lead.lead_source || 'Direct';
    }

    // Get status class
    function getStatusClass(status) {
      return `status-${status || 'new'}`;
    }

    // Render leads table
    function renderLeads() {
      leadsTableBody.innerHTML = leads.map(lead => `
        <tr class="hover:bg-gray-50" data-lead-id="${lead.lead_id}">
          <td class="px-4 py-4">
            <div class="font-medium text-gray-900">${lead.first_name || ''} ${lead.last_name || ''}</div>
            <div class="text-sm text-gray-500">${formatDate(lead.submitted_at)}</div>
          </td>
          <td class="px-4 py-4">
            <div class="text-sm">${lead.email || '-'}</div>
            <div class="text-sm text-gray-500">${lead.phone || '-'}</div>
          </td>
          <td class="px-4 py-4">
            <div class="text-sm font-medium">${lead.event_type || '-'}</div>
            <div class="text-sm text-gray-500">${lead.guest_count || '-'} guests</div>
          </td>
          <td class="px-4 py-4">
            <span class="text-sm">${getSource(lead)}</span>
            ${lead.gclid ? '<span class="ml-1 text-xs text-green-600" title="Has gclid for ROI tracking">$</span>' : ''}
          </td>
          <td class="px-4 py-4">
            <select
              class="status-select px-2 py-1 text-sm rounded-full ${getStatusClass(lead.status)}"
              data-lead-id="${lead.lead_id}"
              data-current-status="${lead.status || 'new'}"
            >
              <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
              <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
              <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
              <option value="won" ${lead.status === 'won' ? 'selected' : ''}>Won</option>
              <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
            </select>
          </td>
          <td class="px-4 py-4">
            ${lead.booking_value ? `<span class="font-medium text-green-600">$${lead.booking_value.toLocaleString()}</span>` : '-'}
          </td>
          <td class="px-4 py-4">
            <button
              class="notes-btn text-amber-600 hover:text-amber-800"
              data-lead-id="${lead.lead_id}"
              data-lead-name="${lead.first_name || ''} ${lead.last_name || ''}"
              data-notes="${(lead.notes || '').replace(/"/g, '&quot;')}"
              title="Edit notes"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
          </td>
        </tr>
      `).join('');

      // Attach event listeners to status selects
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', handleStatusChange);
      });

      // Attach event listeners to notes buttons
      document.querySelectorAll('.notes-btn').forEach(btn => {
        btn.addEventListener('click', handleNotesClick);
      });
    }

    // Handle status change
    async function handleStatusChange(e) {
      const select = e.target;
      const leadId = select.dataset.leadId;
      const newStatus = select.value;
      const oldStatus = select.dataset.currentStatus;

      // If changing to "won", show the booking value modal
      if (newStatus === 'won') {
        currentWonLeadId = leadId;
        wonModal.classList.remove('hidden');
        document.getElementById('bookingValueInput').focus();
        // Reset to old status until confirmed
        select.value = oldStatus;
        return;
      }

      await updateLeadStatus(leadId, newStatus);
    }

    // Update lead status
    async function updateLeadStatus(leadId, status, bookingValue = null) {
      try {
        const body = { status };
        if (bookingValue) body.booking_value = bookingValue;

        const response = await fetch(`/api/admin/leads/${leadId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        // Refresh the list
        await fetchLeads();
      } catch (err) {
        console.error('Error updating status:', err);
        alert('Failed to update status: ' + err.message);
        await fetchLeads(); // Refresh to reset UI
      }
    }

    // Handle notes click
    function handleNotesClick(e) {
      const btn = e.currentTarget;
      currentNotesLeadId = btn.dataset.leadId;
      document.getElementById('notesLeadName').textContent = btn.dataset.leadName;
      document.getElementById('notesTextarea').value = btn.dataset.notes || '';
      notesModal.classList.remove('hidden');
      document.getElementById('notesTextarea').focus();
    }

    // Save notes
    async function saveNotes() {
      if (!currentNotesLeadId) return;

      const notes = document.getElementById('notesTextarea').value;

      try {
        const response = await fetch(`/api/admin/leads/${currentNotesLeadId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        notesModal.classList.add('hidden');
        currentNotesLeadId = null;
        await fetchLeads();
      } catch (err) {
        console.error('Error saving notes:', err);
        alert('Failed to save notes: ' + err.message);
      }
    }

    // Confirm won
    async function confirmWon() {
      if (!currentWonLeadId) return;

      const bookingValue = parseFloat(document.getElementById('bookingValueInput').value);

      if (!bookingValue || bookingValue <= 0) {
        alert('Please enter a valid booking value');
        return;
      }

      await updateLeadStatus(currentWonLeadId, 'won', bookingValue);

      wonModal.classList.add('hidden');
      currentWonLeadId = null;
      document.getElementById('bookingValueInput').value = '';
    }

    // Fetch leads
    async function fetchLeads() {
      loading.classList.remove('hidden');
      error.classList.add('hidden');
      tableContainer.classList.add('hidden');
      pagination.classList.add('hidden');

      try {
        const params = new URLSearchParams({
          status: currentFilter,
          limit: pageSize.toString(),
          offset: (currentPage * pageSize).toString()
        });

        const response = await fetch(`/api/admin/leads?${params}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        leads = result.leads || [];
        totalCount = result.totalCount || 0;

        // Update stats
        updateStats();

        // Render table
        renderLeads();

        // Update pagination
        document.getElementById('showingStart').textContent = totalCount > 0 ? (currentPage * pageSize + 1) : 0;
        document.getElementById('showingEnd').textContent = Math.min((currentPage + 1) * pageSize, totalCount);
        document.getElementById('showingTotal').textContent = totalCount;

        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = (currentPage + 1) * pageSize >= totalCount;

        loading.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        pagination.classList.remove('hidden');
      } catch (err) {
        console.error('Error fetching leads:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        errorMessage.textContent = 'Failed to load leads: ' + err.message;
      }
    }

    // Update stats (simplified - could fetch separate counts)
    function updateStats() {
      document.getElementById('stat-total').textContent = totalCount;

      // Count by status from current data (approximation)
      const newCount = leads.filter(l => l.status === 'new' || !l.status).length;
      const contactedCount = leads.filter(l => l.status === 'contacted').length;
      const wonCount = leads.filter(l => l.status === 'won').length;
      const revenue = leads.reduce((sum, l) => sum + (l.booking_value || 0), 0);

      document.getElementById('stat-new').textContent = newCount;
      document.getElementById('stat-contacted').textContent = contactedCount;
      document.getElementById('stat-won').textContent = wonCount;
      document.getElementById('stat-revenue').textContent = revenue > 0 ? `$${revenue.toLocaleString()}` : '-';
    }

    // Event listeners
    statusFilter.addEventListener('change', (e) => {
      currentFilter = e.target.value;
      currentPage = 0;
      fetchLeads();
    });

    refreshBtn.addEventListener('click', fetchLeads);

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        fetchLeads();
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if ((currentPage + 1) * pageSize < totalCount) {
        currentPage++;
        fetchLeads();
      }
    });

    document.getElementById('cancelNotesBtn').addEventListener('click', () => {
      notesModal.classList.add('hidden');
      currentNotesLeadId = null;
    });

    document.getElementById('saveNotesBtn').addEventListener('click', saveNotes);

    document.getElementById('cancelWonBtn').addEventListener('click', () => {
      wonModal.classList.add('hidden');
      currentWonLeadId = null;
      document.getElementById('bookingValueInput').value = '';
    });

    document.getElementById('confirmWonBtn').addEventListener('click', confirmWon);

    // Close modals on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        notesModal.classList.add('hidden');
        wonModal.classList.add('hidden');
        currentNotesLeadId = null;
        currentWonLeadId = null;
      }
    });

    // Initial load
    fetchLeads();
  </script>
</body>
</html>
