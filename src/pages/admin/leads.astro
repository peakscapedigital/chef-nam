---
// Lead Management Admin Page
import '../../styles/global.css';

export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Lead Management | Chef Nam</title>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Lead Management</h1>
        <p class="text-gray-600 mt-1">Manage and track your catering leads</p>
      </div>
      <div class="flex flex-wrap gap-4 items-center">
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
          <option value="all">All Leads</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="quoted">Quoted</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
          <input type="checkbox" id="includeTestToggle" class="w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500">
          Show test leads
        </label>
        <button id="refreshBtn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
          Refresh
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-gray-900" id="stat-total">-</div>
        <div class="text-sm text-gray-600">Total Leads</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-blue-600" id="stat-new">-</div>
        <div class="text-sm text-gray-600">New</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-amber-600" id="stat-contacted">-</div>
        <div class="text-sm text-gray-600">Contacted</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-purple-600" id="stat-quoted">-</div>
        <div class="text-sm text-gray-600">Quoted</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-green-600" id="stat-won">-</div>
        <div class="text-sm text-gray-600">Won</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="text-2xl font-bold text-green-700" id="stat-revenue">-</div>
        <div class="text-sm text-gray-600">Revenue</div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-amber-500 border-t-transparent"></div>
      <p class="mt-4 text-gray-600">Loading leads...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
      <span id="errorMessage"></span>
    </div>

    <!-- Leads Table -->
    <div id="tableContainer" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex justify-between items-center mt-4">
      <div class="text-sm text-gray-600">
        Showing <span id="showingStart">0</span>-<span id="showingEnd">0</span> of <span id="showingTotal">0</span>
      </div>
      <div class="flex gap-2">
        <button id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50" disabled>Previous</button>
        <button id="nextBtn" class="px-4 py-2 border border-gray-300 rounded-lg bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50" disabled>Next</button>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div id="notesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4 shadow-xl">
      <h3 class="text-lg font-semibold mb-4">Notes for <span id="notesLeadName"></span></h3>
      <textarea id="notesTextarea" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
      <div class="flex justify-end gap-3 mt-4">
        <button id="cancelNotesBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
        <button id="saveNotesBtn" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">Save Notes</button>
      </div>
    </div>
  </div>

  <!-- Won Modal -->
  <div id="wonModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-xl">
      <h3 class="text-lg font-semibold mb-4">Mark Lead as Won</h3>
      <p class="text-gray-600 mb-4">Enter the booking value for this lead:</p>
      <div class="flex items-center gap-2 mb-4">
        <span class="text-gray-500">$</span>
        <input type="number" id="bookingValueInput" min="0" step="100" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., 4200">
      </div>
      <div class="flex justify-end gap-3">
        <button id="cancelWonBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
        <button id="confirmWonBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Confirm Won</button>
      </div>
    </div>
  </div>

  <!-- Value Modal (for editing value without changing status) -->
  <div id="valueModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-xl">
      <h3 class="text-lg font-semibold mb-4">Edit Booking Value for <span id="valueLeadName"></span></h3>
      <div class="flex items-center gap-2 mb-4">
        <span class="text-gray-500">$</span>
        <input type="number" id="editValueInput" min="0" step="100" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., 4200">
      </div>
      <div class="flex justify-end gap-3">
        <button id="cancelValueBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
        <button id="saveValueBtn" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">Save Value</button>
      </div>
    </div>
  </div>

  <style>
    .status-new { background-color: #dbeafe; color: #1e40af; }
    .status-contacted { background-color: #fef3c7; color: #92400e; }
    .status-qualified { background-color: #d1fae5; color: #065f46; }
    .status-quoted { background-color: #e9d5ff; color: #6b21a8; }
    .status-won { background-color: #bbf7d0; color: #166534; }
    .status-lost { background-color: #fecaca; color: #991b1b; }
  </style>

  <script>
    // State
    let leads = [];
    let currentPage = 0;
    let totalCount = 0;
    const pageSize = 50;
    let currentFilter = 'all';
    let includeTest = false;
    let currentNotesLeadId = null;
    let currentWonLeadId = null;
    let currentValueLeadId = null;

    // Elements
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const tableContainer = document.getElementById('tableContainer');
    const leadsTableBody = document.getElementById('leadsTableBody');
    const pagination = document.getElementById('pagination');
    const statusFilter = document.getElementById('statusFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const notesModal = document.getElementById('notesModal');
    const wonModal = document.getElementById('wonModal');
    const valueModal = document.getElementById('valueModal');

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      let date;
      // BigQuery may return timestamps as scientific notation (Unix seconds) or ISO string
      if (typeof dateStr === 'number' || /^[\d.]+[Ee]/.test(dateStr) || /^\d+\.?\d*$/.test(dateStr)) {
        // Unix timestamp in seconds (possibly scientific notation)
        const seconds = parseFloat(dateStr);
        date = new Date(seconds * 1000);
      } else {
        date = new Date(dateStr);
      }
      if (isNaN(date.getTime())) return '-';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getSource(lead) {
      if (lead.gclid) return 'Google Ads';
      if (lead.fbclid) return 'Facebook';
      if (lead.utm_source) return lead.utm_source;
      if (lead.utm_medium === 'organic') return 'Organic';
      return lead.lead_source || 'Direct';
    }

    function getStatusClass(status) {
      return `status-${status || 'new'}`;
    }

    function renderLeads() {
      if (!leadsTableBody) return;

      leadsTableBody.innerHTML = leads.map(lead => {
        const isTest = lead.is_test === true || lead.is_test === 'true';
        return `
        <tr class="hover:bg-gray-50 ${isTest ? 'bg-yellow-50' : ''}" data-lead-id="${lead.lead_id}">
          <td class="px-4 py-4">
            <div class="font-medium text-gray-900">
              ${lead.first_name || ''} ${lead.last_name || ''}
              ${isTest ? '<span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded">TEST</span>' : ''}
            </div>
            <div class="text-sm text-gray-500">${formatDate(lead.submitted_at)}</div>
          </td>
          <td class="px-4 py-4">
            <div class="text-sm">${lead.email || '-'}</div>
            <div class="text-sm text-gray-500">${lead.phone || '-'}</div>
          </td>
          <td class="px-4 py-4">
            <div class="text-sm font-medium">${lead.event_type || '-'}</div>
            <div class="text-sm text-gray-500">${lead.guest_count || '-'} guests</div>
          </td>
          <td class="px-4 py-4">
            <span class="text-sm">${getSource(lead)}</span>
            ${lead.gclid ? '<span class="ml-1 text-xs text-green-600 font-bold" title="Has gclid for ROI tracking">$</span>' : ''}
          </td>
          <td class="px-4 py-4">
            <select
              class="status-select px-3 py-1 text-sm rounded-full font-medium cursor-pointer ${getStatusClass(lead.status)}"
              data-lead-id="${lead.lead_id}"
              data-current-status="${lead.status || 'new'}"
            >
              <option value="new" ${lead.status === 'new' || !lead.status ? 'selected' : ''}>New</option>
              <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
              <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
              <option value="quoted" ${lead.status === 'quoted' ? 'selected' : ''}>Quoted</option>
              <option value="won" ${lead.status === 'won' ? 'selected' : ''}>Won</option>
              <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
            </select>
          </td>
          <td class="px-4 py-4">
            <button
              class="value-btn hover:bg-gray-100 px-2 py-1 rounded transition-colors"
              data-lead-id="${lead.lead_id}"
              data-lead-name="${lead.first_name || ''} ${lead.last_name || ''}"
              data-value="${lead.booking_value || ''}"
              title="Click to edit value"
            >
              ${lead.booking_value ? `<span class="font-medium text-green-600">$${Number(lead.booking_value).toLocaleString()}</span>` : '<span class="text-gray-400">+ Add</span>'}
            </button>
          </td>
          <td class="px-4 py-4">
            <button
              class="notes-btn text-amber-600 hover:text-amber-800 p-1"
              data-lead-id="${lead.lead_id}"
              data-lead-name="${lead.first_name || ''} ${lead.last_name || ''}"
              data-notes="${(lead.notes || '').replace(/"/g, '&quot;')}"
              title="Edit notes"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
          </td>
        </tr>
      `}).join('');

      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', handleStatusChange);
      });

      document.querySelectorAll('.notes-btn').forEach(btn => {
        btn.addEventListener('click', handleNotesClick);
      });

      document.querySelectorAll('.value-btn').forEach(btn => {
        btn.addEventListener('click', handleValueClick);
      });
    }

    async function handleStatusChange(e) {
      const select = e.target;
      const leadId = select.dataset.leadId;
      const newStatus = select.value;
      const oldStatus = select.dataset.currentStatus;

      if (newStatus === 'won') {
        currentWonLeadId = leadId;
        wonModal?.classList.remove('hidden');
        document.getElementById('bookingValueInput')?.focus();
        select.value = oldStatus;
        return;
      }

      await updateLeadStatus(leadId, newStatus);
    }

    async function updateLeadStatus(leadId, status, bookingValue = null) {
      try {
        const body = { status };
        if (bookingValue) body.booking_value = bookingValue;

        const response = await fetch(`/api/admin/leads/${leadId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        await fetchLeads();
      } catch (err) {
        console.error('Error updating status:', err);
        alert('Failed to update status: ' + err.message);
        await fetchLeads();
      }
    }

    function handleNotesClick(e) {
      const btn = e.currentTarget;
      currentNotesLeadId = btn.dataset.leadId;
      const leadNameEl = document.getElementById('notesLeadName');
      const textareaEl = document.getElementById('notesTextarea');
      if (leadNameEl) leadNameEl.textContent = btn.dataset.leadName;
      if (textareaEl) textareaEl.value = btn.dataset.notes || '';
      notesModal?.classList.remove('hidden');
      textareaEl?.focus();
    }

    async function saveNotes() {
      if (!currentNotesLeadId) return;

      const notes = document.getElementById('notesTextarea')?.value || '';

      try {
        const response = await fetch(`/api/admin/leads/${currentNotesLeadId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        notesModal?.classList.add('hidden');
        currentNotesLeadId = null;
        await fetchLeads();
      } catch (err) {
        console.error('Error saving notes:', err);
        alert('Failed to save notes: ' + err.message);
      }
    }

    function handleValueClick(e) {
      const btn = e.currentTarget;
      currentValueLeadId = btn.dataset.leadId;
      const leadNameEl = document.getElementById('valueLeadName');
      const inputEl = document.getElementById('editValueInput');
      if (leadNameEl) leadNameEl.textContent = btn.dataset.leadName;
      if (inputEl) (inputEl as HTMLInputElement).value = btn.dataset.value || '';
      valueModal?.classList.remove('hidden');
      inputEl?.focus();
    }

    async function saveValue() {
      if (!currentValueLeadId) return;

      const bookingValue = parseFloat((document.getElementById('editValueInput') as HTMLInputElement)?.value || '0');

      try {
        const response = await fetch(`/api/admin/leads/${currentValueLeadId}/value`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ booking_value: bookingValue || 0 })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        valueModal?.classList.add('hidden');
        currentValueLeadId = null;
        await fetchLeads();
      } catch (err) {
        console.error('Error saving value:', err);
        alert('Failed to save value: ' + err.message);
      }
    }

    async function confirmWon() {
      if (!currentWonLeadId) return;

      const bookingValue = parseFloat(document.getElementById('bookingValueInput')?.value || '0');

      if (!bookingValue || bookingValue <= 0) {
        alert('Please enter a valid booking value');
        return;
      }

      await updateLeadStatus(currentWonLeadId, 'won', bookingValue);

      wonModal?.classList.add('hidden');
      currentWonLeadId = null;
      const input = document.getElementById('bookingValueInput');
      if (input) input.value = '';
    }

    async function fetchLeads() {
      loading?.classList.remove('hidden');
      error?.classList.add('hidden');
      tableContainer?.classList.add('hidden');
      pagination?.classList.add('hidden');

      try {
        const params = new URLSearchParams({
          status: currentFilter,
          limit: pageSize.toString(),
          offset: (currentPage * pageSize).toString(),
          includeTest: includeTest.toString()
        });

        const response = await fetch(`/api/admin/leads?${params}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error);
        }

        leads = result.leads || [];
        totalCount = result.totalCount || 0;

        updateStats();
        renderLeads();

        const showingStart = document.getElementById('showingStart');
        const showingEnd = document.getElementById('showingEnd');
        const showingTotal = document.getElementById('showingTotal');

        if (showingStart) showingStart.textContent = totalCount > 0 ? String(currentPage * pageSize + 1) : '0';
        if (showingEnd) showingEnd.textContent = String(Math.min((currentPage + 1) * pageSize, totalCount));
        if (showingTotal) showingTotal.textContent = String(totalCount);

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        if (prevBtn) prevBtn.disabled = currentPage === 0;
        if (nextBtn) nextBtn.disabled = (currentPage + 1) * pageSize >= totalCount;

        loading?.classList.add('hidden');
        tableContainer?.classList.remove('hidden');
        pagination?.classList.remove('hidden');
      } catch (err) {
        console.error('Error fetching leads:', err);
        loading?.classList.add('hidden');
        error?.classList.remove('hidden');
        if (errorMessage) errorMessage.textContent = 'Failed to load leads: ' + err.message;
      }
    }

    function updateStats() {
      const statTotal = document.getElementById('stat-total');
      const statNew = document.getElementById('stat-new');
      const statContacted = document.getElementById('stat-contacted');
      const statQuoted = document.getElementById('stat-quoted');
      const statWon = document.getElementById('stat-won');
      const statRevenue = document.getElementById('stat-revenue');

      if (statTotal) statTotal.textContent = String(totalCount);

      const newCount = leads.filter(l => l.status === 'new' || !l.status).length;
      const contactedCount = leads.filter(l => l.status === 'contacted').length;
      const quotedCount = leads.filter(l => l.status === 'quoted').length;
      const wonCount = leads.filter(l => l.status === 'won').length;
      const revenue = leads.reduce((sum, l) => sum + (Number(l.booking_value) || 0), 0);

      if (statNew) statNew.textContent = String(newCount);
      if (statContacted) statContacted.textContent = String(contactedCount);
      if (statQuoted) statQuoted.textContent = String(quotedCount);
      if (statWon) statWon.textContent = String(wonCount);
      if (statRevenue) statRevenue.textContent = revenue > 0 ? `$${revenue.toLocaleString()}` : '-';
    }

    // Event listeners
    statusFilter?.addEventListener('change', (e) => {
      currentFilter = (e.target as HTMLSelectElement).value;
      currentPage = 0;
      fetchLeads();
    });

    document.getElementById('includeTestToggle')?.addEventListener('change', (e) => {
      includeTest = (e.target as HTMLInputElement).checked;
      currentPage = 0;
      fetchLeads();
    });

    refreshBtn?.addEventListener('click', fetchLeads);

    document.getElementById('prevBtn')?.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        fetchLeads();
      }
    });

    document.getElementById('nextBtn')?.addEventListener('click', () => {
      if ((currentPage + 1) * pageSize < totalCount) {
        currentPage++;
        fetchLeads();
      }
    });

    document.getElementById('cancelNotesBtn')?.addEventListener('click', () => {
      notesModal?.classList.add('hidden');
      currentNotesLeadId = null;
    });

    document.getElementById('saveNotesBtn')?.addEventListener('click', saveNotes);

    document.getElementById('cancelWonBtn')?.addEventListener('click', () => {
      wonModal?.classList.add('hidden');
      currentWonLeadId = null;
      const input = document.getElementById('bookingValueInput');
      if (input) (input as HTMLInputElement).value = '';
    });

    document.getElementById('confirmWonBtn')?.addEventListener('click', confirmWon);

    document.getElementById('cancelValueBtn')?.addEventListener('click', () => {
      valueModal?.classList.add('hidden');
      currentValueLeadId = null;
      const input = document.getElementById('editValueInput');
      if (input) (input as HTMLInputElement).value = '';
    });

    document.getElementById('saveValueBtn')?.addEventListener('click', saveValue);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        notesModal?.classList.add('hidden');
        wonModal?.classList.add('hidden');
        valueModal?.classList.add('hidden');
        currentNotesLeadId = null;
        currentValueLeadId = null;
        currentWonLeadId = null;
      }
    });

    // Initial load
    fetchLeads();
  </script>
</body>
</html>
